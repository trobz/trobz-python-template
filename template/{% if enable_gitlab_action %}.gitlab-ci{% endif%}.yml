stages:
  - test
  - release

test:
  stage: test
  image: python:3.13
  script:
    - make test
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'

# Semantic release job
semantic-release:
  stage: release
  image: python:3.13

  # Critical variables for GitLab integration
  variables:
    GIT_STRATEGY: clone
    GIT_DEPTH: 0  # Full git history needed for semantic-release
    # Ensure we can make commits
    GIT_AUTHOR_NAME: "GitLab CI"
    GIT_AUTHOR_EMAIL: "$GITLAB_USER_EMAIL"
    GIT_COMMITTER_NAME: "GitLab CI"
    GIT_COMMITTER_EMAIL: "$GITLAB_USER_EMAIL"

  before_script:
    # Configure git for making commits
    - git config --global user.name "GitLab CI"
    - git config --global user.email "$GITLAB_USER_EMAIL"
    # Checkout the branch (important for pushing changes back)
    - git checkout -B "$CI_COMMIT_REF_NAME"
    # Ensure we have the remote configured properly for pushing
    - git remote set-url origin "https://gitlab-ci-token:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git"

  script:
    # Install python-semantic-release
    - pip install python-semantic-release
    # Run semantic release
    - semantic-release version --print
    - semantic-release version
    - semantic-release changelog
    - semantic-release publish

  rules:
    # Only run on main branch pushes (not merge requests)
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'

  # Allow manual triggering for testing
  when: on_success
